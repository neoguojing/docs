Tcmalloc

- 2.8 GHz P4 50ns malloc/free pair
- 减少多线程下的锁竞争
- 小对象分配占用额外空间小:8N * 1.01 
- 起始内存6m
- 不会返回内存给系统


## 架构

- 小对象 < 32k
- 大对象 > 32k
- thread-local cache:线程本地缓存: 负责小对象分配;按需从central heap获取内存;无锁设计;总大小为2M,超过则寻找空闲对象返回到central heap
- central heap: 中央堆,负责分配大对象,按页(4k)分配;定期从thread-local cache回收内存垃圾;线程共享,有锁

## 小对象分配

![avatar](http://goog-perftools.sourceforge.net/doc/threadheap.gif)

- 按大小分类:内存分为8bytes 到2k类型;
- 单项列表存储空闲对象列表
- 本地缓存分配: 1.匹配申请的内存大小;2.从对应大小的空闲列表头部去下内存,返回
- 中央缓存分配: 1.本地缓存列表为空;2.从中央缓存对应大小的空闲列表获取一批内存,放到本地缓存;3.返回头部的内存
- 系统分配: 1.中央缓存列表为空;2.从系统申请,并分裂为对应大小内存;3.放入中央列表;4.返回部分到本地缓存

## 大对象分配

![avatar](http://goog-perftools.sourceforge.net/doc/pageheap.gif)
- 在central heap中分配
- 1-255 page类型的空闲列表
- 256个列表为>=256的page列表
- 分配: 匹配到对应大小列表;所有列表都不能满足,则从系统申请
- 多余page会插入到合适的page列表

## spans
- 记录一串连续的page集合,记录小对象的size-class等,记录大对象的起始和结束页;
- 可以为一组空闲页的集合
- 已分配页的集合: 1.已经分配给应用的内存大对象 2.已经分裂的小对象,span会记录小对象的分类
- 64bit system 3-level radix tree 3层的基数树存储page到span的映射
- 32bit 中央数组记录page到span的映射
- 
## 内存回收
- 通过查找标记,区分是小对象/大对象
- 小对象回收: 插入到当前本地缓存的对应的空闲列表;并触发垃圾回收,检查总内存是否超过2M
- 大对象回收: 找到span对应的页,并查看相邻的内存是否空闲,空闲则合并一起插入对应的中央缓存区

## 中央缓存-小对象的空闲列表
- 二维结构
- span集合
- 以及每个span对应的空闲对象列表
- 小对象分配的实质: 从多个span的空闲列表选择最合适的尺寸
- 小对象回收: 对象备归还到对应span的空闲列表,若空闲列表等于span中的对象个数,即所有对象都空闲,则将span归还到页堆

 ## 垃圾回收
 - 本地缓存超过２Ｍ,则触发垃圾回收
 - 随着线程数量增多,缓存上限会逐渐缩小
 - 回收的对象数量由 low-water-mark 决定
 - low-water-mark 记录上次垃圾回收之后的最小列表长度
 - 每次移动L/2的空闲对象到中央缓存

## 扩展

/dev/mem是物理内存的全映像，可以用来访问物理内存，一般用法是open("/dev/mem",O_RDWR|O_SYNC)，接着就可以用mmap来访问物理内存以及外设的IO资源，这就是实现用户空间驱动的一种方法；
全映像：指的是小于４Ｇ，非IO内存,非lowmem
radix tree 基数树: 根据一个长整型（比如一个长ID）快速查找到其对应的对象指针; 必hash效率高
 身份鉴别号整数值ID与对象指针建立关联表
 Linux内核利用radix树在文件内偏移快速定位文件缓存页

